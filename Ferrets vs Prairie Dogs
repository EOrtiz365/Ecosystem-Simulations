<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferret vs. Prairie Dog</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Ensure the grid cells are square */
        .grid-cell {
            aspect-ratio: 1 / 1;
            transition: all 0.2s ease;
        }
        /* Style for the "active" tool button */
        .tool-active {
            outline: 4px solid #60a5fa; /* ring-4 ring-blue-400 */
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-green-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Ferret vs. Prairie Dog</h1>
        <p class="text-center text-gray-600 mb-4">A Predator-Prey Simulation</p>

        <!-- Control Panel -->
        <div class="flex flex-col sm:flex-row gap-2 justify-center mb-4 p-4 bg-white rounded-xl shadow-lg">
            <div class="flex-1">
                <h2 class="font-semibold text-lg">Instructions</h2>
                <ol class="list-decimal list-inside text-sm text-gray-700">
                    <li>Click <strong>"Place/Remove Dogs"</strong> button.</li>
                    <li>Click on the grid to place or remove üêπ cards.</li>
                    <li>Click <strong>"Release Ferret!"</strong> to drop a ferret. You can do this multiple times.</li>
                    <li>Eaten prairie dogs ü¶¥ are removed.</li>
                    <li>When finished, click <strong>"Start Next Turn"</strong> to log data and continue.</li>
                    <li>The game tracks 20 weeks. Click <strong>"Reset Game"</strong> to start over.</li>
                </ol>
            </div>
            <div class="flex flex-col gap-2 sm:w-1/3">
                <button id="place-dog-button" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-blue-600 transition-all tool-active disabled:opacity-50">
                    1. Place/Remove Dogs üêπ
                </button>
                <button id="release-ferret-button" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-red-600 transition-all disabled:opacity-50">
                    2. Release Ferret! ü¶ä
                </button>
                <button id="next-turn-button" class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-green-600 transition-all hidden">
                    Start Next Turn üîÑ
                </button>
                <button id="reset-button" class="w-full bg-gray-400 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-gray-500 transition-all mt-2">
                    Reset Game
                </button>
            </div>
        </div>
        
        <!-- Status Message & Week Counter -->
        <div class="flex justify-between items-center h-8 mb-2 px-2">
            <div id="status-message" class="text-lg font-semibold text-gray-700">
                Place your prairie dogs...
            </div>
            <div id="dog-counter-display" class="text-lg font-semibold text-gray-700">
                Prairie Dogs: <span id="dog-counter">0</span>
            </div>
            <div class="text-lg font-semibold text-gray-700">
                Week: <span id="week-counter">1</span> / 20
            </div>
        </div>

        <!-- Game Area (Board + Table) -->
        <div class="flex flex-col lg:flex-row gap-6">
            
            <!-- Game Board (Left Side) -->
            <div id="game-board" class="relative w-full lg:w-1/2 mx-auto bg-green-600 rounded-lg shadow-inner overflow-hidden aspect-square">
                <!-- Grid cells will be generated by JS -->
            </div>

            <!-- Data Table (Right Side) -->
            <div class="w-full lg:w-1/2">
                <h2 class="text-xl font-semibold text-center text-gray-800 mb-2">Game Data</h2>
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div id="table-scroll-container" class="overflow-y-auto" style="height: 300px;"> <!-- Reduced height -->
                        <table class="w-full min-w-full">
                            <thead class="bg-gray-200 sticky top-0 z-10">
                                <tr>
                                    <th class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Week</th>
                                    <th class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Start üêπ</th>
                                    <th class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Start ü¶ä</th>
                                    <th class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Survive üêπ</th>
                                    <th class="py-2 px-3 text-sm font-semibold text-gray-600 text-center">Survive ü¶ä</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!-- Data rows will be generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            
                <!-- New Graph Area -->
                <h2 class="text-xl font-semibold text-center text-gray-800 mt-6 mb-2">Population Graph</h2>
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <canvas id="population-graph"></canvas>
                </div>

            </div>

        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Element References ---
            const boardContainer = document.getElementById('game-board');
            const placeDogButton = document.getElementById('place-dog-button');
            const releaseFerretButton = document.getElementById('release-ferret-button');
            const nextTurnButton = document.getElementById('next-turn-button');
            const resetButton = document.getElementById('reset-button');
            const statusEl = document.getElementById('status-message');
            const weekCounterEl = document.getElementById('week-counter');
            const dogCounterEl = document.getElementById('dog-counter');
            const dogCounterDisplay = document.getElementById('dog-counter-display');
            const tableBody = document.getElementById('data-table-body');
            const tableScrollContainer = document.getElementById('table-scroll-container');

            // --- Game State ---
            const GRID_SIZE = 10;
            const MAX_WEEKS = 20;
            let boardState = [];
            let isPlacingPrairieDogs = true;
            let ferretPlaced = false; // Has the ferret-dropping phase begun this turn?
            let currentWeek = 1;
            let currentDogCount = 0;
            let gameData = [];
            let populationChart; // New variable for the chart
            
            // --- State for cumulative multi-ferret drops ---
            let turnStartDogCount = 0; // How many dogs we started this turn with
            let ferretsReleasedThisTurn = 0; // Counter for ferrets
            let totalEatenThisTurn = 0; // Cumulative eaten dogs
            let totalFerretsSurvivedThisTurn = 0; // Cumulative surviving ferrets

            // --- Game Functions ---

            /**
             * Initializes the game board and state
             */
            function initGame() {
                boardContainer.innerHTML = ''; // Clear board
                boardState = Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0));
                ferretPlaced = false;
                isPlacingPrairieDogs = true;
                currentWeek = 1;
                currentDogCount = 0; // Reset count
                gameData = [];
                
                // Reset multi-ferret state
                turnStartDogCount = 0;
                ferretsReleasedThisTurn = 0;
                totalEatenThisTurn = 0;
                totalFerretsSurvivedThisTurn = 0;

                // Clear table and week counter
                tableBody.innerHTML = '';
                weekCounterEl.textContent = currentWeek;
                dogCounterEl.textContent = '0'; // Reset display
                dogCounterDisplay.classList.remove('hidden'); // Show display

                // Remove any old ferret card (initGame clears boardContainer, so this is covered)

                // Create grid cells
                const gridWrapper = document.createElement('div');
                gridWrapper.className = 'grid grid-cols-10 w-full h-full';

                for (let r = 0; r < GRID_SIZE; r++) {
                    for (let c = 0; c < GRID_SIZE; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell bg-green-400 hover:bg-green-300 border border-green-700/50 flex items-center justify-center text-3xl select-none cursor-pointer';
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        cell.addEventListener('click', handleCellClick);
                        gridWrapper.appendChild(cell);
                    }
                }
                boardContainer.appendChild(gridWrapper);

                // Update UI
                statusEl.textContent = 'Place your prairie dogs...';
                placeDogButton.classList.add('tool-active');
                releaseFerretButton.classList.remove('tool-active');
                
                // Ensure correct button visibility and state on reset
                releaseFerretButton.classList.remove('hidden');
                nextTurnButton.classList.add('hidden');
                placeDogButton.disabled = false;
                releaseFerretButton.disabled = false;

                // Initialize the graph
                initGraph();
            }

            /**
             * Handles clicking on a grid cell
             */
            function handleCellClick(e) {
                if (!isPlacingPrairieDogs) return; // Only allow placement if in that phase

                const row = parseInt(e.target.dataset.row);
                const col = parseInt(e.target.dataset.col);

                // Toggle prairie dog
                if (boardState[row][col] === 0) {
                    boardState[row][col] = 1;
                    e.target.innerHTML = 'üêπ';
                    e.target.classList.add('bg-amber-800'); // Dirt mound color
                    currentDogCount++; // Increment
                } else {
                    boardState[row][col] = 0;
                    e.target.innerHTML = '';
                    e.target.classList.remove('bg-amber-800');
                    currentDogCount--; // Decrement
                }
                dogCounterEl.textContent = currentDogCount; // Update display
            }

            /**
             * Activates the prairie dog placement tool
             */
            function activatePlacement() {
                if (ferretPlaced || currentWeek > MAX_WEEKS) return; // Can't place after ferret phase has begun
                isPlacingPrairieDogs = true;
                placeDogButton.classList.add('tool-active');
                releaseFerretButton.classList.remove('tool-active');
            }

            /**
             * Places *one* 3x3 ferret card randomly and calculates the outcome
             */
            function releaseFerret() {
                if (currentWeek > MAX_WEEKS) return; // Game over

                // --- 1. Handle First Drop of the Turn ---
                if (!ferretPlaced) {
                    // This is the FIRST ferret drop of the turn
                    turnStartDogCount = currentDogCount;
                    ferretPlaced = true;
                    isPlacingPrairieDogs = false;
                    placeDogButton.classList.remove('tool-active');
                    releaseFerretButton.classList.add('tool-active');
                    placeDogButton.disabled = true; // Disable placement until next turn
                    dogCounterDisplay.classList.add('hidden'); // Hide live counter
                    
                    // Show the "Next Turn" button
                    nextTurnButton.classList.remove('hidden'); 
                }
                
                // --- 2. Run Simulation for *this* ferret ---
                ferretsReleasedThisTurn++;
                
                const topRow = Math.floor(Math.random() * (GRID_SIZE - 2)); // 0-7
                const leftCol = Math.floor(Math.random() * (GRID_SIZE - 2)); // 0-7

                let eatenCountThisFerret = 0;

                // Check the 3x3 area for prairie dogs
                for (let r = topRow; r < topRow + 3; r++) {
                    for (let c = leftCol; c < leftCol + 3; c++) {
                        // CRITICAL: Only eat if it's a prairie dog (1), not an empty spot (0) or bones
                        if (boardState[r][c] === 1) {
                            eatenCountThisFerret++;
                            boardState[r][c] = 0; // Prairie dog is eaten
                            
                            // Visually update the eaten cell
                            const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                            if (cell) {
                                cell.innerHTML = 'ü¶¥'; // Bones
                                cell.classList.remove('bg-amber-800');
                                cell.classList.add('bg-red-300'); // "Eaten" spot
                            }
                        }
                    }
                }

                // --- 3. Determine Survival & Update Turn Totals ---
                const ferretSurvived = eatenCountThisFerret >= 2;
                
                totalEatenThisTurn += eatenCountThisFerret;
                if (ferretSurvived) {
                    totalFerretsSurvivedThisTurn++;
                }
                
                // Update the live dog count (for internal logic, display is hidden)
                currentDogCount -= eatenCountThisFerret;
                
                // --- 4. Display Ferret Card ---
                const ferretEl = document.createElement('div');
                // Give it a class, not an ID, so we can have multiple
                ferretEl.className = 'ferret-card-instance absolute flex items-center justify-center bg-gray-800/70 border-4 rounded-lg transition-all duration-300';
                ferretEl.style.width = '30%';
                ferretEl.style.height = '30%';
                ferretEl.style.top = `${topRow * 10}%`; // 10% per cell
                ferretEl.style.left = `${leftCol * 10}%`;

                if (ferretSurvived) {
                    ferretEl.innerHTML = '<span class="text-6xl" role="img" aria-label="Ferret">ü¶ä</span>';
                    ferretEl.classList.add('border-green-500');
                } else {
                    ferretEl.innerHTML = '<span class="text-6xl" role="img" aria-label="Skull">üíÄ</span>';
                    ferretEl.classList.add('border-red-500', 'grayscale');
                }
                
                boardContainer.appendChild(ferretEl);

                // --- 5. Update Status Message with Cumulative Data ---
                statusEl.textContent = `Ferrets: ${ferretsReleasedThisTurn} | Total Eaten: ${totalEatenThisTurn} | Ferrets Survived: ${totalFerretsSurvivedThisTurn}`;
            }

            /**
             * Adds a week's data to the table
             */
            function addWeekToTable(data) {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 even:bg-gray-50';
                row.innerHTML = `
                    <td class="py-2 px-3 text-center">${data.week}</td>
                    <td class="py-2 px-3 text-center">${data.startDogs}</td>
                    <td class="py-2 px-3 text-center">${data.startFerrets}</td>
                    <td class="py-2 px-3 text-center">${data.survivingDogs}</td>
                    <td class="py-2 px-3 text-center">${data.survivingFerrets}</td>
                `;
                tableBody.appendChild(row);
                // Auto-scroll
                tableScrollContainer.scrollTop = tableScrollContainer.scrollHeight;
            }

            /**
             * Initializes the Chart.js graph
             */
            function initGraph() {
                // Destroy old chart if it exists
                if (populationChart) {
                    populationChart.destroy();
                }

                const ctx = document.getElementById('population-graph').getContext('2d');
                populationChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [], // Weeks
                        datasets: [
                            {
                                label: 'Surviving Prairie Dogs üêπ',
                                data: [], // Dog counts
                                borderColor: 'rgb(161, 98, 7)', // Tailwind 'amber-800'
                                backgroundColor: 'rgba(161, 98, 7, 0.5)',
                                tension: 0.1
                            },
                            {
                                label: 'Surviving Ferrets ü¶ä',
                                data: [], // Ferret counts
                                borderColor: 'rgb(220, 38, 38)', // Tailwind 'red-600'
                                backgroundColor: 'rgba(220, 38, 38, 0.5)',
                                tension: 0.1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Population Over Time'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Population'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Week'
                                }
                            }
                        }
                    }
                });
            }

            /**
             * Updates the graph with new data for the week
             */
            function updateGraph(weekData) {
                if (populationChart) {
                    populationChart.data.labels.push(weekData.week);
                    populationChart.data.datasets[0].data.push(weekData.survivingDogs);
                    populationChart.data.datasets[1].data.push(weekData.survivingFerrets);
                    populationChart.update();
                }
            }


            /**
             * Resets the board for the next turn (removes ferret, bones)
             */
            function startNextTurn() {
                if (!ferretPlaced) return; // Can only run if a ferret has been dropped

                // --- 1. Log the cumulative data from the turn ---
                const startDogs = turnStartDogCount;
                const startFerrets = ferretsReleasedThisTurn; // Use the counter
                const survivingFerrets = totalFerretsSurvivedThisTurn; // Use the counter
                // This is the most accurate way to get surviving dogs
                const survivingDogs = turnStartDogCount - totalEatenThisTurn;

                const weekData = {
                    week: currentWeek,
                    startDogs: startDogs,
                    startFerrets: startFerrets,
                    survivingDogs: survivingDogs,
                    survivingFerrets: survivingFerrets
                };
                gameData.push(weekData);
                addWeekToTable(weekData);
                updateGraph(weekData); // Update the graph with the new data

                // --- 2. Remove all ferret cards ---
                document.querySelectorAll('.ferret-card-instance').forEach(el => el.remove());

                // --- 3. Reset state for next turn ---
                ferretPlaced = false;
                isPlacingPrairieDogs = true;
                turnStartDogCount = 0;
                ferretsReleasedThisTurn = 0;
                totalEatenThisTurn = 0;
                totalFerretsSurvivedThisTurn = 0;

                // --- 4. Clean up "eaten" cells (bones) AND recalculate dog count ---
                currentDogCount = 0;
                for (let r = 0; r < GRID_SIZE; r++) {
                    for (let c = 0; c < GRID_SIZE; c++) {
                        const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                        
                        if (boardState[r][c] === 1) { // Check for surviving dogs
                            currentDogCount++;
                        }

                        // Only clear bones, leave prairie dogs (üêπ) alone
                        if (cell && cell.innerHTML === 'ü¶¥') {
                            cell.innerHTML = '';
                            cell.classList.remove('bg-red-300');
                        }
                    }
                }
                dogCounterEl.textContent = currentDogCount; // Set new count
                dogCounterDisplay.classList.remove('hidden'); // Show counter

                // --- 5. Increment week ---
                currentWeek++;
                weekCounterEl.textContent = currentWeek;

                // --- 6. Update UI ---
                statusEl.textContent = 'Place or remove prairie dogs for the next turn...';
                placeDogButton.classList.add('tool-active');
                releaseFerretButton.classList.remove('tool-active');
                placeDogButton.disabled = false; // Re-enable placement

                // --- 7. Swap buttons ---
                releaseFerretButton.classList.remove('hidden');
                nextTurnButton.classList.add('hidden');

                // --- 8. Check for Game Over ---
                if (currentWeek > MAX_WEEKS) {
                    statusEl.textContent = 'Game Over! 20 weeks complete. Reset to play again.';
                    placeDogButton.disabled = true;
                    releaseFerretButton.disabled = true;
                    nextTurnButton.classList.add('hidden'); // Hide just in case
                }
            }

            // --- Event Listeners ---
            placeDogButton.addEventListener('click', activatePlacement);
            releaseFerretButton.addEventListener('click', releaseFerret);
            nextTurnButton.addEventListener('click', startNextTurn);
            resetButton.addEventListener('click', initGame);

            // --- Start Game ---
            initGame();
        });
    </script>
</body>
</html>
